---
layout: post
title: "ğŸ¸ Táº¡o SSL/TLS miá»…n phÃ­ vá»›i OpenSSL vÃ  Letâ€™s Encrypt"
categories: IT
tags: [debian, wordpress, linux, ssl]
author: thu4nvd
---

NgÃ y nay, háº§u háº¿t cÃ¡c website Ä‘á»u Ä‘Ã£ sá»­ dá»¥ng giao thá»©c HTTPS thay cho HTTP. HTTPS lÃ  pháº§n má»Ÿ rá»™ng báº£o máº­t cá»§a HTTP, nÃ³ lÃ  giao thá»©c dÃ¹ng cÆ¡ cháº¿ báº£o máº­t SSL Ä‘á»ƒ mÃ£ hÃ³a thÃ´ng tin.
Äá»ƒ sá»­ dá»¥ng Ä‘Æ°á»£c giao thá»©c nÃ y, chÃºng ta cáº§n cÃ³ má»™t bá»™ chá»©ng chá»‰ SSL/TLS Ä‘á»ƒ xÃ¡c thá»±c cho domain. 

Váº­y lÃ m sao Ä‘á»ƒ cÃ³ Ä‘Æ°á»£c chá»©ng chá»‰ nÃ y má»™t cÃ¡ch an toÃ n vÃ  miá»…n phÃ­.
CÃ¹ng tÃ¬m hiá»ƒu nhÃ©.

## SSL/TLS lÃ  gÃ¬?
SSL lÃ  Secure Sockets Layer (Lá»›p socket báº£o máº­t), nÃ³ lÃ  má»™t cÆ¡ cháº¿ báº£o máº­t báº±ng cÃ¡ch mÃ£ hÃ³a thÃ´ng tin liÃªn láº¡c giá»¯a clien vÃ  server.
TLS (Transport Layer Security), cÅ©ng lÃ  má»™t cÆ¡ cháº¿ báº£o máº­t â€“ báº£o máº­t lá»›p truyá»n dáº«n (trong khÃ¡i niá»‡m máº¡ng) â€“ nÃ³ ra Ä‘á»i Ä‘á»ƒ thay tháº¿ cho SSL giá» khÃ´ng cÃ²n Ä‘Æ°á»£c phÃ¡t triá»ƒn.
HTTPS â€“ nÃ³ lÃ  má»™t pháº§n má»Ÿ rá»™ng cá»§a giao thá»©c truyá»n ná»™i dung text HTTP giá»¯a client vÃ  server (giá»¯a trÃ¬nh duyá»‡t vÃ  mÃ¡y chá»§ web), báº£n thÃ´ng tin liÃªn láº¡c báº±ng HTTP khÃ´ng Ä‘Æ°á»£c mÃ£ hÃ³a, cÃ¡c gÃ³i tin cÃ³ thá»ƒ Ä‘á»c Ä‘Æ°á»£c khi truyá»n dáº«n.   
HTTPS lÃ  giao thá»©c dÃ¹ng cÆ¡ cháº¿ báº£o máº­t SSL/TLS Ä‘á»ƒ mÃ£ hÃ³a thÃ´ng tin.

## SSL hoáº¡t Ä‘á»™ng nhÆ° tháº¿ nÃ o?

![alt text](/assets/2023/02/ssl-handshake.jpg)
TLS dÃ¹ng public key vÃ  private key, cÃ³ má»™t sá»‘ cÃ¡ch thá»©c sá»­ dá»¥ng TLS táº¡o ra káº¿t ná»‘i an toÃ n, sÆ¡ Ä‘á»“ trÃªn (one-way TLS) lÃ  má»™t cÃ¡ch thá»©c, nÃ³ hoáº¡t Ä‘á»™ng qua cÃ¡c bÆ°á»›c:
- TrÃ¬nh duyá»‡t gá»­i yÃªu cáº§u má»™t phiÃªn lÃ m viá»‡c an toÃ n tá»›i mÃ¡y chá»§.
- MÃ¡y tráº£ vá» má»™t chá»©ng chá»‰, chá»©ng chá»‰ nÃ y cÃ³ chá»©a public key cá»§a server, chá»©ng chá»‰ nÃ y phÃ¡t sinh bá»Ÿi server vÃ  trÃªn server cÃ³ chá»©a private key ná»¯a (private key khÃ´ng Ä‘Æ°á»£c gá»­i tá»›i trÃ¬nh duyá»‡t).
- TrÃ¬nh duyá»‡t cáº§n kÃ½ nháº­n chá»©ng chá»‰, nÃ³ táº¡o ra yÃªu cáº§u tá»›i **CA (Certificate Authority)** Ä‘á»ƒ chá»©ng thá»±c chá»©ng chá»‰.
- TrÃ¬nh duyá»‡t vÃ  mÃ¡y chá»§ trao Ä‘á»•i má»™t sá»‘ thÃ´ng tin Ä‘á»ƒ kiá»ƒm tra cÃ¡c key.
- TrÃ¬nh duyá»‡t vÃ  Server báº¯t Ä‘áº§u trao Ä‘á»•i dá»¯ liá»‡u Ä‘Æ°á»£c mÃ£ hÃ³a TLS.
Certificate Authority lÃ  nhÃ  cung cáº¥p chá»©ng chá»‰ sá»‘ (cung cáº¥p public key/private key cho server) â€“ CA pháº£i Ä‘áº£m báº£o Ä‘Æ°á»£c danh tÃ­nh chÃ­nh xÃ¡c cá»¥ thá»ƒ cá»§a Ä‘á»‘i tÆ°á»£ng (server, webiste) Ä‘Æ°á»£c cung cáº¥p chá»©ng chá»‰ â€“ báº±ng cÃ¡ch xÃ¡c nháº­n thÃ´ng tin cá»§a cÃ¡ nhÃ¢n, tá»• chá»©c.

## Táº¡i sao cáº§n sá»­ dá»¥ng SSL/TLS?

Hai má»¥c Ä‘Ã­ch chÃ­nh cá»§a SSL/TLS lÃ :
- Báº£o máº­t Ä‘Æ°á»ng truyá»n cho website.   
  * Náº¿u chá»‰ sá»­ dá»¥ng giao thá»©c HTTP thÃ¬ dá»¯ liá»‡u trao Ä‘á»•i giá»¯a client vÃ  server sáº½ khÃ´ng Ä‘Æ°á»£c mÃ£ hÃ³a vÃ  báº¥t ká»³ mÃ¡y tÃ­nh nÃ o á»Ÿ giá»¯a cÃ³ thá»ƒ báº¯t gÃ³i tin vÃ  Ä‘á»c cÃ¡c thÃ´ng tin nháº¡y cáº£m (username, password, thÃ´ng tin tháº» tÃ­n dá»¥ng) tá»« gÃ³i tin Ä‘Ã³.
- GiÃºp cho website cá»§a báº¡n Ä‘Æ°á»£c xÃ¡c thá»±c, nÃ¢ng cao Ä‘á»™ tin tÆ°á»Ÿng cho ngÆ°á»i dÃ¹ng.
  * NgoÃ i mÃ£ hÃ³a, má»™t chá»©ng nháº­n SSL thÃ­ch há»£p cÅ©ng cung cáº¥p sá»± xÃ¡c thá»±c. Hiá»ƒu nÃ´m na lÃ  domain cá»§a báº¡n sáº½ Ä‘Æ°á»£c má»™t bÃªn thá»© 3 uy tÃ­n xÃ¡c thá»±c ráº±ng nÃ³ thuá»™c sá»Ÿ há»¯u cá»§a cÃ¡ nhÃ¢n hoáº·c tá»• chá»©c cá»§a báº¡n. Äiá»u nÃ y cÃ³ nghÄ©a lÃ  khÃ¡ch hÃ ng cÃ³ thá»ƒ cháº¯c cháº¯n ráº±ng mÃ¬nh Ä‘ang gá»­i thÃ´ng tin Ä‘áº¿n Ä‘Ãºng nÆ¡i chá»© khÃ´ng pháº£i Ä‘áº¿n má»™t káº» nÃ o Ä‘Ã³ Ä‘ang máº¡o danh cÃ¡ nhÃ¢n, tá»• chá»©c cá»§a báº¡n Ä‘á»ƒ cá»‘ gáº¯ng Äƒn cáº¯p thÃ´ng tin cá»§a khÃ¡ch hÃ ng.  
  
NgoÃ i ra, khi website cá»§a báº¡n sá»­ dá»¥ng SSL/TLS nÃ³ sáº½ dá»… tiáº¿p cáº­n vá»›i ngÆ°á»i dÃ¹ng hÆ¡n trÃªn Google, vÃ¬ Google sáº½ Æ°u tiÃªn hiá»ƒn thá»‹ cÃ¡c website sá»­ dá»¥ng https (HTTP + SSL/TLS) hÆ¡n khi tÃ¬m kiáº¿m, cÃ¡c website sá»­ dá»¥ng HTTP sáº½ bá»‹ coi lÃ  unsafe.


## CÃ¡c loáº¡i chá»©ng chá»‰ SSL/TLS
Chá»©ng chá»‰ SSL Ä‘Æ°á»£c phÃ¢n chia thÃ nh 3 loáº¡i chÃ­nh, sáº½ khÃ¡c vá» cÃ¡ch xÃ¡c thá»±c vÃ  thÃ´ng tin chá»©a trong chá»©ng chá»‰, nhÆ°ng kháº£ nÄƒng báº£o máº­t lÃ  nhÆ° nhau:
- DV SSL (Domain Validated): Chá»©ng chá»‰ Ä‘Æ°á»£c xÃ¡c thá»±c vá»›i cáº¥p Ä‘á»™ tÃªn miá»n.
- OV SSL (Organization Validated): Chá»©ng chá»‰ Ä‘Æ°á»£c xÃ¡c thá»±c vá»›i cáº¥p Ä‘á»™ doanh nghiá»‡p/tá»• chá»©c.
- EV SSL (Extended Validated): Chá»©ng chá»‰ Ä‘Æ°á»£c xÃ¡c thá»±c vá»›i cáº¥p Ä‘á»™ doanh nghiá»‡p/tá»• chá»©c má»Ÿ rá»™ng.


## Má»™t sá»‘ cÃ¡ch Ä‘á»ƒ cÃ³ chá»©ng chá»‰ SSL miá»…n phÃ­
- Sá»­ dá»¥ng CloudFlare: ÄÃ¢y lÃ  má»™t website cung cáº¥p dá»‹ch vá»¥ tÄƒng tá»‘c vÃ  báº£o máº­t website, há» cÃ³ cung cáº¥p chá»©ng chá»‰ SSL á»Ÿ gÃ³i Free, viá»‡c Ä‘Äƒng kÃ½ cÅ©ng ráº¥t dá»… dÃ ng.
- Sá»­ dá»¥ng OpenSSL
- Sá»­ dá»¥ng Letâ€™s Encrypt

## Sá»­ dá»¥ng OpenSSL Ä‘á»ƒ táº¡o SSL miá»…n phÃ­

OpenSSL lÃ  cÃ´ng cá»¥ mÃ£ hÃ³a SSL/TLS, sá»­ dá»¥ng nÃ³ Ä‘á»ƒ táº¡o/quáº£n lÃ½ cÃ¡c public key/private key â€“ dÃ¹ng nÃ³ Ä‘á»ƒ sinh cÃ¡c chá»©ng chá»‰ SSL tá»± xÃ¡c thá»±c.
VÃ¬ lÃ  chá»©ng chá»‰ tá»± xÃ¡c thá»±c nÃªn bá»™ chá»©ng chá»‰ SSL do OpenSSL sinh ra chá»‰ cung cáº¥p má»¥c Ä‘Ã­ch báº£o máº­t Ä‘Æ°á»ng truyá»n chá»© khÃ´ng Ä‘Æ°á»£c verify vÃ  Google cÅ©ng sáº½ Ä‘Ã¡nh dáº¥u website sá»­ dá»¥ng loáº¡i chá»©ng chá»‰ nÃ y lÃ  unsafe.
OpenSSL phÃ¹ há»£p cho viá»‡c:
- Thá»±c hÃ nh lÃ m quen vá»›i SSL
- Táº¡o SSL cho cÃ¡c domain ná»™i bá»™ trong VLAN khÃ´ng cáº§n xÃ¡c thá»±c

## CÃ¡c bÆ°á»›c táº¡o chá»©ng chá»‰ SSL vá»›i OpenSSL

Äáº§u tiÃªn báº¡n cháº¡y lá»‡nh sau:
```bash
openssl genrsa -out ca.key 2048
```
Sau lá»‡nh nÃ y openssl sinh ra file tÃªn ca.key chá»©a **RSA PRIVATE KEY.**
Tiáº¿p theo cháº¡y lá»‡nh:
```bash
openssl req -new -key ca.key -out ca.csr
```
Báº¡n nháº­p cÃ¡c thÃ´ng tin theo yÃªu cáº§u, vÃ­ dá»¥ nhÆ° sau:
```
Country Name (2 letter code) [XX]:VN
State or Province Name (full name) []:Ha Noi
Locality Name (eg, city) [Default City]:Ha Noi
Organization Name (eg, company) [Default Company Ltd]: alivu.com
Organizational Unit Name (eg, section) []:IT Department
Common Name (eg, your name or your server's hostname) []:alivu.com
```
Náº¿u há»‡ thá»‘ng cÃ³ há»i thÃªm cÃ¡c thÃ´ng tin: Email, Optional company name, hay Challenge password thÃ¬ bá» qua báº±ng cÃ¡ch nháº¥n Enter.
Sau lá»‡nh nÃ y openssl sinh ra file ca.csr chá»©a **CERTIFICATE REQUEST **(Ä‘Ã¢y lÃ  file dÃ¹ng Ä‘á»ƒ request chá»©ng chá»‰).
Tiáº¿p theo cháº¡y lá»‡nh Ä‘á»ƒ tá»± gen chá»©ng chá»‰:
```bash
openssl x509 -req -days 365 -in ca.csr -signkey ca.key -out ca.crt
```
Sau lá»‡nh nÃ y nÃ³ sinh ra file **CERTIFICATE** tÃªn: ca.crt
Äáº¿n Ä‘Ã¢y thu Ä‘Æ°á»£c cÃ¡c file Ä‘á»ƒ sá»­ dá»¥ng:
> Chá»©ng chá»‰ (public key): ca.crt  
> Private key: ca.key

LÆ°u Ã½ báº­t SSL module báº±ng cÃ¢u lá»‡nh, náº¿u khÃ´ng sáº½ bá»‹ bÃ¡o lá»—i _"Invalid command 'SSLEngine', perhaps misspelled or defined by a module not included in the server configuration"_
```bash
sudo a2enmod ssl
sudo systemctl restart apache2 
```
Báº¡n cÃ³ thá»ƒ sá»­ dá»¥ng 2 file nÃ y Ä‘á»ƒ cáº¥u hÃ¬nh SSL cho website, nhÆ°ng vÃ¬ Ä‘Ã¢y lÃ  chá»©ng chá»‰ tá»± xÃ¡c thá»±c nÃªn trÃ¬nh duyá»‡t sáº½ xuáº¥t hiá»‡n cáº£nh bÃ¡o.

LÃºc nÃ y viá»‡c xÃ¡c thá»±c cáº§n pháº£i tá»« má»™t CA, báº¡n cÃ³ thá»ƒ mua chá»©ng chá»‰ SSL/TLS Ä‘á»ƒ cÃ³ public key/private key vÃ  sá»­ dá»¥ng nhÆ° trÃªn, hoáº·c láº¥y cert miá»…n phÃ­a tá»« CA Letâ€™s Encrypt.

## Sá»­ dá»¥ng Letâ€™s Encrypt Ä‘á»ƒ láº¥y SSL miá»…n phÃ­

Letâ€™s Encrypt lÃ  chá»©ng nháº­n (CA) má»Ÿ, miá»…n phÃ­ vÃ  tá»± Ä‘á»™ng, hoáº¡t Ä‘á»™ng vÃ¬ lá»£i Ã­ch cá»™ng Ä‘á»“ng. ÄÃ¢y lÃ  dá»‹ch vá»¥ Ä‘Æ°á»£c cung cáº¥p bá»Ÿi Internet Security Research Group (ISRG).
Äá»ƒ láº¥y cert SSL tá»« Letâ€™s Encrypt, Ä‘áº§u tiÃªn báº¡n cáº§n cÃ i Ä‘áº·t certbot â€“ Ä‘Ã¢y lÃ  cÃ´ng cá»¥ láº¥y chá»©ng chá»‰ SSL Letâ€™s Encrypt
```bash
sudo apt install certbot python3-certbot-nginx
```
Kiá»ƒm tra xem certbot Ä‘Ã£ Ä‘Æ°á»£c cÃ i Ä‘áº·t thÃ nh cÃ´ng hay chÆ°a
```bash
certbot --version
```
Tiáº¿p theo, báº¡n cháº¡y lá»‡nh phÃ­a dÆ°á»›i Ä‘á»ƒ gen cert SSL
```bash
certbot certonly --standalone -d elove.mobi --staple-ocsp -m test@elove.mobi --agree-tos
```
LÆ°u Ã½, vÃ¬ cert SSL do Letâ€™s Encrypt cung cáº¥p lÃ  cert SSL cáº¥p Ä‘á»™ DV (chá»©ng chá»‰ Ä‘Æ°á»£c xÃ¡c thá»±c vá»›i cáº¥p Ä‘á»™ tÃªn miá»n) nÃªn báº¡n pháº£i Ä‘áº£m báº£o tÃªn miá»n trá» vá» Ä‘Ãºng vá» Ä‘á»‹a chá»‰ IP Public cá»§a server cháº¡y lá»‡nh certbot.

á» Ä‘Ã¢y server cháº¡y lá»‡nh certbot cá»§a mÃ¬nh cÃ³ IP Public lÃ  171.244.53.226
CÃ³ thá»ƒ cháº¡y cÃ¢u lá»‡nh sau Ä‘á»ƒ láº¥y Ä‘á»‹a chá»‰ IP public
```
curl ifconfig.io -4
```
Báº¡n pháº£i Ä‘áº£m báº£o trÃªn DNS domain elove.mobi pháº£i Ä‘Æ°á»£c trá» Ä‘Ãºng vá» IP Public nÃ y
Náº¿u khÃ´ng, báº¡n sáº½ gáº·p lá»—i xÃ¡c thá»±c tÃªn miá»n
![alt text](/assets/2023/02/ssl-with-openssl-letsencrypt-output-2.png)

Náº¿u thÃ nh cÃ´ng , báº¡n sáº½ nháº­n Ä‘Æ°á»£c 2 file Ä‘á»ƒ sá»­ dá»¥ng
>    Chá»©ng chá»‰ (public key): fullchain.pem  
>    Private key: privkey.pem
![alt text](/assets/2023/02/ssl-with-openssl-letsencrypt-output-1.jpg)

Äáº¿n Ä‘Ã¢y, cÃ¡c báº¡n Ä‘Ã£ cÃ³ chá»©ng chá»‰ SSL miá»…n phÃ­ Ä‘á»ƒ sá»­ dá»¥ng.

## Cáº¥u hÃ¬nh SSL cho má»™t sá»‘ tool phá»• biáº¿n

Apache
```
<VirtualHost *:443>
    ...
    SSLEngine on
    SSLCertificateFile [Ä‘Æ°á»ng dáº«n Ä‘áº¿n ]fullchain.pem
    SSLCertificateKeyFile [Ä‘Æ°á»ng dáº«n Ä‘áº¿n]privkey.pem
    ...
</VirtualHost>
```

Nginx
```
server {
    listen 443 ssl;
    # RSA certificate
    ssl_certificate [Ä‘Æ°á»ng dáº«n Ä‘áº¿n ]fullchain.pem
    ssl_certificate_key [Ä‘Æ°á»ng dáº«n Ä‘áº¿n]privkey.pem
    include /etc/letsencrypt/options-ssl-nginx.conf;
}
```
Haproxy
Haproxy ná»‘i cáº£ file private key vÃ  public key thÃ nh 1 file Ä‘á»ƒ sá»­ dá»¥ng nÃªn chÃºng ta cáº§n ghÃ©p 2 file nÃ y trÆ°á»›c báº±ng lá»‡nh
```bash
cat "privkey.pem" "fullchain.pem" > "ssl-cert.pem"
```
Trong khá»‘i pront end cá»§a haproxy cÃ³ thá»ƒ dÃ¹ng
```
frontend https
    bind *:443 ssl crt [Ä‘Æ°á»ng dáº«n Ä‘áº¿n]ssl-cert.pem
    ...
```

## Reference

- Guide on Quoc9x ğŸ‘‰[Link](https://quoc9x.com/2023/04/20/huong-dan-tao-ssl-tls-mien-phi-voi-openssl-va-lets-encrypt/)